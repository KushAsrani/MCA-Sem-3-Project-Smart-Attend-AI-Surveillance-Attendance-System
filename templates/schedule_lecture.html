{% extends "base.html" %}

{% block content %}
<div class="min-h-screen py-10 px-4 sm:px-6 lg:px-8 flex items-center justify-center">
    
    <div class="bg-white w-full max-w-lg rounded-2xl shadow-xl border border-slate-100 p-8">
        
        <!-- Header Section -->
        <div class="text-center mb-8">
            <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                <!-- Icon changes based on mode -->
                <i class="fa-solid {{ 'fa-pen-to-square' if edit_data else 'fa-calendar-plus' }}"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-800">
                {{ 'Update Schedule' if edit_data else 'Schedule Lecture' }}
            </h2>
            <p class="text-slate-500 text-sm">
                {{ 'Modify lecture details below.' if edit_data else 'Reserve a slot and classroom.' }}
            </p>
        </div>

        <div class="space-y-5">
            
            <!-- Hidden Input: ID (Only present if editing) -->
            <input type="hidden" id="schedule_id" value="{{ edit_data.id if edit_data else '' }}">

            <!-- Course / Batch Selector -->
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">Course / Batch</label>
                <select id="course" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:border-indigo-500 focus:outline-none transition-all cursor-pointer">
                    <option value="" disabled {{ 'selected' if not edit_data }}>Select Class</option>
                    <option value="MCA" {{ 'selected' if edit_data and edit_data.course == 'MCA' }}>MCA</option>
                    <option value="BMS" {{ 'selected' if edit_data and edit_data.course == 'BMS' }}>BMS</option>
                    <option value="MMS" {{ 'selected' if edit_data and edit_data.course == 'MMS' }}>MMS</option>
                </select>
            </div>

            <!-- Subject -->
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">Subject</label>
                <input type="text" id="subject" value="{{ edit_data.subject if edit_data else '' }}" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:border-indigo-500 focus:outline-none" placeholder="e.g. Artificial Intelligence">
            </div>

            <!-- Classroom No -->
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">Classroom No</label>
                <input type="text" id="classroom" value="{{ edit_data.classroom if edit_data else '' }}" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:border-indigo-500 focus:outline-none" placeholder="e.g. Lab 3 or Room 402">
            </div>

            <!-- Date Input -->
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">Date</label>
                <input type="date" id="date" value="{{ edit_data.date if edit_data else '' }}" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:border-indigo-500 focus:outline-none">
            </div>

            <!-- Time Slots -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">Start Time</label>
                    <input type="time" id="start_time" value="{{ edit_data.start_time if edit_data else '' }}" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:border-indigo-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">End Time</label>
                    <input type="time" id="end_time" value="{{ edit_data.end_time if edit_data else '' }}" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:border-indigo-500 focus:outline-none">
                </div>
            </div>

            <!-- Action Buttons -->
            <button onclick="saveSchedule()" id="save-btn" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-500/30 transition-all mt-4">
                {{ 'Update Schedule' if edit_data else 'Confirm Schedule' }}
            </button>

            <a href="/teacher_dashboard" class="block text-center text-slate-500 text-sm font-medium hover:text-indigo-600">Cancel</a>
        </div>
    </div>
</div>

<script>
    async function saveSchedule() {
        // 1. Get Data from Form
        const id = document.getElementById('schedule_id').value;
        const course = document.getElementById('course').value;
        const subject = document.getElementById('subject').value;
        const classroom = document.getElementById('classroom').value;
        const date = document.getElementById('date').value;
        const start_time = document.getElementById('start_time').value;
        const end_time = document.getElementById('end_time').value;
        const btn = document.getElementById('save-btn');

        // 2. Validation
        if(!course || !subject || !classroom || !date || !start_time || !end_time) {
            alert("Please fill all fields!");
            return;
        }

        // 3. UI Loading State
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
        btn.disabled = true;

        const payload = { 
            id: id, // Empty string if new, Value if edit
            course: course, 
            subject: subject, 
            classroom: classroom, 
            date: date, 
            start_time: start_time, 
            end_time: end_time 
        };

        try {
            // 4. Send to Backend
            const response = await fetch('/save_schedule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            // 5. Handle Response
            if (result.status === 'success') {
                alert("Success: " + result.msg);
                window.location.href = "/teacher_dashboard";
            } else {
                alert("Conflict Alert!\n" + result.msg); 
                // Reset Button Text
                btn.innerHTML = id ? "Update Schedule" : "Confirm Schedule";
                btn.disabled = false;
            }
        } catch (err) {
            console.error(err);
            alert("Server Error. Check terminal for logs.");
            btn.disabled = false;
        }
    }
</script>
{% endblock %}